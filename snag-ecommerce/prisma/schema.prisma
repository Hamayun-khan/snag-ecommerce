// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
        provider = "prisma-client-js"
            output   = "../generated/prisma"
}

datasource db {
        provider = "postgresql"
            url      = env("DATABASE_URL")
}

model Product {
        id          String   @id @default(cuid())
            name        String
                price       Float
                    imageUrl    String
                        description String
                            category    String
                                stock       Int      @default(10)
                                    inStock     Boolean  @default(true)
                                        createdAt   DateTime @default(now())
                                            orderItems  OrderItem[]
                                                
                                                    @@index([category])
                                                        @@index([inStock])
}

model User {
        id                String    @id // This will be Clerk's userId
            email             String    @unique
                firstName         String?
                    lastName          String?
                        stripeCustomerId  String?   @unique // Link to Stripe customer
                            createdAt         DateTime  @default(now())
                                updatedAt         DateTime  @updatedAt
                                    
                                        // Relationships
                                            orders            Order[]
                                                
                                                    @@index([email])
                                                        @@index([stripeCustomerId])
}


model Order {
        id              String      @id @default(cuid())
            email           String
                customerName    String
                    shippingAddress String
                        city            String
                            postalCode      String
                                country         String
                                    totalAmount     Float
                                        
                                            // ENUM for type safety - matches your webhook handler
                                                status          OrderStatus @default(PENDING)
                                                    
                                                        // Stripe fields - BOTH are needed for your webhooks
                                                            stripeSessionId String?     @unique  // From checkout.session events
                                                                stripePaymentId String? @unique  // From payment_intent events
                                                                    
                                                                        // Timestamps for tracking
                                                                            createdAt       DateTime    @default(now())
                                                                                updatedAt       DateTime    @updatedAt
                                                                                    paidAt          DateTime?   // When payment completed

                                                                                    userId          String?
                                                                                        user            User?       @relation(fields: [userId], references: [id])
                                                                                            
                                                                                        
                                                                                            // Relationships
                                                                                                items           OrderItem[]
                                                                                                    
                                                                                                        // Indexes for performance
                                                                                                            @@index([email])
                                                                                                                @@index([status])
                                                                                                                    @@index([createdAt])
                                                                                                                        @@index([stripeSessionId])
                                                                                                                            @@index([stripePaymentId])
                                                                                                                             @@index([userId])
}

model OrderItem {
        id        String  @id @default(cuid())
            orderId   String
                productId String
                    name      String
                        price     Float
                            quantity  Int
                                order     Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
                                    product   Product @relation(fields: [productId], references: [id])

                                        @@index([orderId])
                                            @@index([productId])
}

// MUST match the status values in your webhook handler
enum OrderStatus {
        PENDING    // Default when created
            PAID       // checkout.session.completed
                FAILED     // checkout.session.async_payment_failed
                    EXPIRED    // checkout.session.expired
                        CANCELLED  // Manual cancellation
                            REFUNDED   // charge.refunded
                                DISPUTED   // charge.dispute.created
}
